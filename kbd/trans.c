
#include "main.h"
#include "trans.h"
#include "c900.h"
#include "led.h"
#include "at.h"

unsigned char trans1[] = {
 //       F9          F5    F3    F1    F2    F12
    0x00, 0x43, 0x00, 0x3F, 0x3D, 0x3B, 0x3C, 0x00, // 0x00 - 0x07
 //       F10   F8    F6    F4    Tab   `
    0x00, 0x44, 0x42, 0x40, 0x3E, 0x0F, 0x29, 0x00, // 0x08 - 0x0F
 //       Alt   Shift       Ctrl  Q     1
    0x00, 0x38, 0x2A, 0x00, 0x1D, 0x10, 0x02, 0x00, // 0x10 - 0x17
 //             Z     S     A     W     2
    0x00, 0x00, 0x2C, 0x1F, 0x1E, 0x11, 0x03, 0x00, // 0x18 - 0x1F
 //       C     X     D     E     4     3
    0x00, 0x2E, 0x2D, 0x20, 0x12, 0x05, 0x04, 0x00, // 0x20 - 0x27
 //       Space V     F     T     R     5
    0x00, 0x39, 0x2F, 0x21, 0x14, 0x13, 0x06, 0x00, // 0x28 - 0x2F
 //       N     B     H     G     Y     6
    0x00, 0x31, 0x30, 0x23, 0x22, 0x15, 0x07, 0x00, // 0x30 - 0x37
 //             M     J     U     7     8
    0x00, 0x00, 0x32, 0x24, 0x16, 0x08, 0x09, 0x00, // 0x38 - 0x3F
 //       ,     K     I     O     0     9
    0x00, 0x33, 0x25, 0x17, 0x18, 0x0B, 0x0A, 0x00, // 0x40 - 0x47
 //       .     /     L     ;     P     -
    0x00, 0x34, 0x35, 0x26, 0x27, 0x19, 0x0C, 0x00, // 0x48 - 0x4F
 //             '           [     +
    0x00, 0x00, 0x28, 0x00, 0x1A, 0x0D, 0x00, 0x00, // 0x50 - 0x57
 // Caps  RShft Enter ]           |
    0x3A, 0x2A, 0x1C, 0x1B, 0x00, 0x2B, 0x00, 0x00, // 0x58 - 0x5F
 //                                     BkSp
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0E, 0x00, // 0x60 - 0x67
 //       n1          n4    n7
    0x00, 0x4F, 0x00, 0x4B, 0x47, 0x00, 0x00, 0x00, // 0x68 - 0x6F
 // n0    n.    n2    n5    n6    n8    Esc   NumLk
    0x52, 0x53, 0x50, 0x4C, 0x4D, 0x48, 0x01, 0x45, // 0x70 - 0x77
 // F11   n+    n3    n-    n*    n9    ScrLk
    0x00, 0x4E, 0x51, 0x4A, 0x46, 0x49, 0x00, 0x00, // 0x78 - 0x7F
 //                   F7
    0x00, 0x00, 0x00, 0x41, 0x00, 0x00, 0x00, 0x00, // 0x80 - 0x87
 //
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x88 - 0x8F
};

unsigned char trans2[] = {
 //
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x00 - 0x07
 //
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x08 - 0x0F
 //       RAlt              RCtrl
    0x00, 0x38, 0x00, 0x00, 0x1D, 0x00, 0x00, 0x00, // 0x10 - 0x17
 //
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x18 - 0x1F
 //
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x20 - 0x27
 //
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x28 - 0x2F
 //
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x30 - 0x37
 //
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x38 - 0x3F
 //
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x40 - 0x47
 //             n/
    0x00, 0x00, 0x54, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x48 - 0x4F
 //
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x50 - 0x57
 //             nEntr
    0x00, 0x00, 0x5E, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x58 - 0x5F
 //
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x60 - 0x67
 //       End         LEFT  Home
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x68 - 0x6F
 // Ins   Del   DOWN        RIGHT UP
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x70 - 0x77
 //             PgDn              PgUp
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x78 - 0x7F
 //
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x80 - 0x87
 //
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x88 - 0x8F
};

#define STATE_CAPS 0x04
#define STATE_NUM 0x02
#define STATE_SCROLL 0x01

unsigned char state;

unsigned char trans_me(unsigned char code)
{
    // If break do nothing
    if(AT_state & AT_STATE_F0) return code;

    if(AT_state & AT_STATE_E0)
    {
        switch(code)
        {
            case 0x6B: // LEFT
                C900_output(0x1D);
                C900_output(0x30);
                C900_output(0x9D);
                return 0;
                
            case 0x74: // RIGHT
                C900_output(0x1D);
                C900_output(0x21);
                C900_output(0x9D);
                return 0;

            case 0x75: // UP
                C900_output(0x1D);
                C900_output(0x19);
                C900_output(0x9D);
                return 0;

            case 0x72: // DOWN
                C900_output(0x1D);
                C900_output(0x31);
                C900_output(0x9D);
                return 0;

            case 0x6C: // Home
                C900_output(0x1D);
                C900_output(0x1E);
                C900_output(0x9D);
                return 0;

            case 0x69: // End
                C900_output(0x1D);
                C900_output(0x12);
                C900_output(0x9D);
                return 0;

            case 0x71: // Del
                C900_output(0x1D);
                C900_output(0x20);
                C900_output(0x9D);
                return 0;

            case 0x7D: // PgUp
                C900_output(0x01);
                C900_output(0x2F);
                return 0;

            case 0x7A: // PgDn
                C900_output(0x1D);
                C900_output(0x2F);
                C900_output(0x9D);
                return 0;
        }
    }
    else
    {
        switch(code)
        {
            case 0x0A: // F8
                C900_output(0x1D);
                C900_output(0x1E);
                C900_output(0x9D);
                C900_output(0x1D);
                C900_output(0x25);
                C900_output(0x9D);
                return 0;
        }
    }
    return code;
}

void trans_loop()
{
    unsigned char code, code2, led, oldstate;

    led = 0;
    
    while(1)
    {
        // Fetch code from the keyboard
        code = AT_input();

        // Handle MicroEmacs shortcuts
        if(state & STATE_SCROLL)
            code = trans_me(code);

        // No key entered in specified time interval - change LED brightness
        if(!code)
        {
            led++;
            if(led < 64)
                LED3_SET(led << 2);
            else if(led < 128)
                LED3_SET((127-led) << 2);
            else
                LED3_SET(0);
            continue;
        }

        // Is that a key scancode?
        if(code < 0x90)
        {
            // Translate through secondary / primarty table
            if(AT_state & AT_STATE_E0)
                code2 = trans2[code];
            else
                code2 = trans1[code];

            if(code2)
            {
                // Add break bit if necessary
                if(AT_state & AT_STATE_F0)
                    code2 |= 0x80;

                // Send the code to the computer
                C900_output(code2);
            }

            // Handle the LEDS
            oldstate = state;
            if(code == 0x58 && !(AT_state & AT_STATE_F0))
                state = state ^ STATE_CAPS;
            if(code == 0x77 && !(AT_state & AT_STATE_F0))
                state = state ^ STATE_NUM;
            if(code == 0x7E && !(AT_state & AT_STATE_F0))
                state = state ^ STATE_SCROLL;

            // Send new LED state if changed
            if(state != oldstate)
            {
                AT_command(0xED);
                AT_command(state);
            }
        }

        // Process keyboard state flags
        AT_process(code);
    }
}

void trans_main()
{
    // Initialize everything
    CLOCK_INIT;
    LED_INIT;
    C900_INIT;
    AT_INIT;

    AT_state = 0;
    state = 0;

    // Delay 1s
    TRANS_DELAY_LONG;

    // Reset the keyboard
    if(0xFA != AT_command(0xFF))
        return;

    // Relese the clock liine so the keyboard can fully reset
    AT_CLOCK_INPUT;

    // Delay 1s
    TRANS_DELAY_LONG;

    // Flash the keyboard LEDs
    AT_command(0xED);
    AT_command(0x02);
    TRANS_DELAY_SHORT;
    AT_command(0xED);
    AT_command(0x04);
    TRANS_DELAY_SHORT;
    AT_command(0xED);
    AT_command(0x01);
    TRANS_DELAY_SHORT;
    AT_command(0xED);
    AT_command(0x00);

    TRANS_DELAY_LONG;

    LED_init();
    LED3_SET(128);
    
    trans_loop();
}
